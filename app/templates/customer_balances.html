<!-- templates/customer_balances.html -->
{% extends "base.html" %}

{% block content %}

<!-- ุนููุงู ู ุชูุถุญ ุจุงูุง ุตูุญู -->
<div class="hero-intro">
    <h1>ูุฏุฑุช ูุงูุฏู ุญุณุงุจ ูุดุชุฑุงู</h1>
    <p>
        ุฏุฑ ุงู ุจุฎุด ูุงูุฏู ุญุณุงุจ ููุง ูุดุชุฑุงู ู ูุณุช ฺฺฉโูุง ุฏุฑุงูุช ุฑุง ุจุงุฑฺฏุฐุงุฑ ฺฉูุฏ.
        <br>
        ุงู ุงุทูุงุนุงุช ูุจูุง ูุญุงุณุจู "ุจุฏู/ุจุณุชุงูฺฉุงุฑ" ุฏุฑ ฺฏุฒุงุฑุดุงุช ูพูุฑุณุงูุช ุฎูุงูุฏ ุจูุฏ.
    </p>
</div>

<form action="/upload-balances" method="post" enctype="multipart/form-data">
    <div class="upload-grid">

        <!-- ุณุชูู ฺูพ: ูุฑู ุงุตู ุขูพููุฏ -->
        <div class="upload-card">
            <div class="upload-card-title">ูุฑุญูู ฑ: ุขูพููุฏ ูุงูโูุง ูุงู</div>
            <div class="upload-card-subtitle">
                ูุงู ูุงูุฏู ุญุณุงุจ (ุฏู ุฑุฏูู) ู ูุงู ฺฺฉโูุง ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ.
            </div>

            <!-- ูุฑูุฏ ฑ: ูุงูุฏู ุญุณุงุจ -->
            <div class="form-row">
                <label>ฑ. ูุงู ุงฺฉุณู ูุงูุฏู ุญุณุงุจ</label><br />
                <input type="file" name="balances_file" accept=".xlsx,.xls" required />
                <small>ูุงู ุฎุฑูุฌ ูุงูุฏู ุงุดุฎุงุต (ุดุงูู ูุงูุ ฺฉุฏ ู ูุงูุฏู ููุง).</small>
            </div>

            <!-- ูุฑูุฏ ฒ: ฺฺฉโูุง -->
            <div class="form-row">
                <label>ฒ. ูุงู ุงฺฉุณู ุงุณูุงุฏ ุฏุฑุงูุชู (ฺฺฉโูุง)</label><br />
                <input type="file" name="checks_file" accept=".xlsx,.xls" required />
                <small>ุฌูุช ุงุชุตุงู ฺฺฉโูุง ูพุงุณ ูุดุฏู ุจู ุญุณุงุจ ูุดุชุฑุงู.</small>
            </div>

            <button type="submit" style="margin-top: 20px;">
                โฌ๏ธ ุจุงุฑฺฏุฐุงุฑ ู ุจุฑูุฒุฑุณุงู ูุงูุฏูโูุง
            </button>
        </div>

        <!-- ุณุชูู ุฑุงุณุช: ุฑุงูููุง + ฺฉุงุฑุชโูุง ุชูุถุญ ูุงูโูุง -->
        <div class="upload-card upload-card-light">
            <div class="upload-card-title">ุฑุงูููุง ุณุงุฎุช ูุงูโูุง</div>
            <div class="upload-card-subtitle">
                ูุณุฑูุง ุฎุฑูุฌ ฺฏุฑูุชู ุฏุฑ ูุฑูโุงูุฒุงุฑ ุญุณุงุจุฏุงุฑ ุขุณุง
            </div>

            <div class="summary-grid">

                <!-- ุฑุงูููุง ูุงูุฏู ุญุณุงุจ -->
                <div class="summary-card summary-sales"> <!-- ุงุณุชูุงุฏู ุงุฒ ฺฉูุงุณ sales ุจุฑุง ุฑูฺฏ ุณุจุฒ/ูุดุงุจู -->
                    <div class="summary-card-header">
                        <div class="summary-title">
                            <div class="summary-icon">๐</div>
                            <div>
                                <div class="summary-title-main">ูุงู ูุงูุฏู ุญุณุงุจ</div>
                                <div class="summary-title-sub">ฺฏุฒุงุฑุด ูุงูุฏู ุงุดุฎุงุต ู ุดุฑฺฉุชโูุง</div>
                            </div>
                        </div>
                        <button type="button" class="pill-button" data-toggle="hint" data-target="balance-hint">
                            ููุงุด ุฑุงูููุง
                        </button>
                    </div>
                    <div id="balance-hint" class="summary-card-body hint-hidden">
                        <div class="hint-title">ูุณุฑ ูพุดููุงุฏ ุฏุฑ ูุฑูโุงูุฒุงุฑ ุขุณุง:</div>
                        <div class="pill-section">
                            <div class="pill-row">
                                <span class="badge-pill">ุฌุฒุฑู ุญุณุงุจุฏุงุฑ</span>
                                <span style="font-size: 20px;">โ</span>
                                <span class="badge-pill">ฺฏุฒุงุฑุดุงุช ุฏูุงุชุฑ</span>
                                <span style="font-size: 20px;">โ</span>
                                <span class="badge-pill" style="background-color: #d1fae5; color: #065f46;">ูุงูุฏู ุญุณุงุจ
                                    ุงุดุฎุงุต</span>
                            </div>
                        </div>
                        <p class="hint-note">
                            ุฎุฑูุฌ ุจุงุฏ ุดุงูู ุณุชููโูุง "ูุงู ุทุฑู ุญุณุงุจ"ุ "ฺฉุฏ" ู "ูุงูุฏู ููุง" ุจุงุดุฏ. (ูุฑูุช ุฏู ูุฏุฑู ุงุณุชุงูุฏุงุฑุฏ)
                        </p>
                    </div>
                </div>

                <!-- ุฑุงูููุง ฺฺฉโูุง -->
                <div class="summary-card summary-checks">
                    <div class="summary-card-header">
                        <div class="summary-title">
                            <div class="summary-icon">๐ณ</div>
                            <div>
                                <div class="summary-title-main">ูุงู ฺฺฉโูุง</div>
                                <div class="summary-title-sub">ูุณุช ฺฉูู ุงุณูุงุฏ ุฏุฑุงูุชู</div>
                            </div>
                        </div>
                        <button type="button" class="pill-button" data-toggle="hint" data-target="checks-hint">
                            ููุงุด ุฑุงูููุง
                        </button>
                    </div>
                    <div id="checks-hint" class="summary-card-body hint-hidden">
                        <div class="hint-title">ูุณุฑ ุขูุงุฏูโุณุงุฒ ูุงู ฺฺฉโูุง ุฏุฑ ูุฑูโุงูุฒุงุฑ ุขุณุง:</div>
                        <div class="pill-section">
                            <div class="pill-row">
                                <span class="badge-pill">ุฌุฒุฑู ุญุณุงุจุฏุงุฑ</span>
                                <span style="font-size: 20px;">โ</span>
                                <span class="badge-pill">ฺฏุฒุงุฑุดุงุช ุฎุฒุงูู ุฏุงุฑ</span>
                                <span style="font-size: 20px;">โ</span>
                                <span class="badge-pill" style="background-color: #ffedd5; color: #9a3412;">ูุณุช ฺฉูู
                                    ุงุณูุงุฏ ุฏุฑุงูุชู</span>
                            </div>
                        </div>
                        <p class="hint-note">
                            ุงู ูุงู ฺฉูฺฉ ูโฺฉูุฏ ุชุง ุงุณูุงุฏ ุฏุฑ ุฌุฑุงู ูุตูู ุฑุง ุดูุงุณุง ฺฉุฑุฏู ู ุชุงุฑุฎ ุณุฑุฑุณุฏ ุขูโูุง ุฑุง ุฏุฑ ูุธุฑ
                            ุจฺฏุฑู.
                        </p>
                    </div>
                </div>

            </div>
        </div>
    </div>
</form>

<hr style="margin: 40px 0; border: 0; border-top: 1px dashed #ccc;">

<!-- ุจุฎุด ุฌุฏูู ููุงุด ุฏุงุฏูโูุง (ูพุงู ุตูุญู) -->
<div class="summary-card">
    <div class="summary-card-header">
        <h2 style="margin:0; font-size: 1.2rem;">ูุณุช ูุงูุฏูโูุง ููุฌูุฏ ุฏุฑ ุณุณุชู</h2>

        <!-- ุฏฺฉููโูุง ุนููุงุช -->
        <div style="display: flex; gap: 10px;">
            <button type="button" class="pill-button" onclick="addNewRow()">โ ุงูุฒูุฏู ุฏุณุช</button>
            <button type="button" class="pill-button" style="background-color: #fee2e2; color: #b91c1c;"
                onclick="clearAllBalances()">๐๏ธ ุญุฐู ููู</button>
        </div>
    </div>

    <div class="summary-card-body">
        <div class="table-wrapper" style="overflow-x: auto;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ฺฉุฏ ูุดุชุฑ</th>
                        <th>ูุงู ูุดุชุฑ</th>
                        <th>ูุงูุฏู ุญุณุงุจ (ุฑุงู)</th>
                        <th>ุนููุงุช</th>
                    </tr>
                </thead>
                <tbody>
                    {% if balances %}
                    {% for row in balances %}
                    <tr>
                        <td>{{ row.display_code }}</td>
                        <td>{{ row.name }}</td>
                        <td style="direction: ltr; text-align: right; color: {{ row.color }}; font-weight: bold;">
                            {{ row.balance_fmt }}
                        </td>
                        <td>
                            <button type="button" class="pill-button" style="padding: 4px 10px; font-size: 0.8em;"
                                onclick="editBalance('{{ row.name }}', '{{ row.raw_code }}', {{ row.balance }})">
                                ูุฑุงุด
                            </button>
                            <button type="button" class="pill-button"
                                style="color:red; background: #fff1f1; padding: 4px 10px; font-size: 0.8em;"
                                onclick="deleteBalance('{{ row.raw_code }}', '{{ row.name }}')">
                                ุญุฐู
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="4" style="text-align:center; padding: 20px; color: #666;">
                            ูููุฒ ุงุทูุงุนุงุช ุจุงุฑฺฏุฐุงุฑ ูุดุฏู ุงุณุช.
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // ุงุณฺฉุฑูพุช ุจุงุฒ ู ุจุณุชู ฺฉุฑุฏู ุฑุงูููุงูุง
    document.addEventListener('DOMContentLoaded', function () {
        const toggleButtons = document.querySelectorAll('[data-toggle="hint"]');
        toggleButtons.forEach(function (btn) {
            btn.addEventListener('click', function () {
                const targetId = this.getAttribute('data-target');
                const targetElement = document.getElementById(targetId);
                if (targetElement) {
                    targetElement.classList.toggle('hint-hidden');
                    if (targetElement.classList.contains('hint-hidden')) {
                        this.textContent = 'ููุงุด ุฑุงูููุง';
                    } else {
                        this.textContent = 'ูุฎู ฺฉุฑุฏู ุฑุงูููุง';
                    }
                }
            });
        });
    });

    // ุงุณฺฉุฑูพุชโูุง ูุฏุฑุช ุฌุฏูู (ูุฑุงุดุ ุญุฐูุ ุงูุฒูุฏู)
    function deleteBalance(code, name) {
        if (confirm("ุขุง ุงุฒ ุญุฐู ุงู ููุฑุฏ ุงุทููุงู ุฏุงุฑุฏุ")) {
            const formData = new FormData();
            formData.append('customer_code', code);
            formData.append('customer_name', name);
            fetch('/delete-balance', { method: 'POST', body: formData }).then(() => location.reload());
        }
    }

    function editBalance(name, code, balance) {
        const newCode = prompt("ฺฉุฏ ูุดุชุฑ:", code);
        if (newCode === null) return;
        const newName = prompt("ูุงู ูุดุชุฑ:", name);
        if (newName === null) return;
        const newBalance = prompt("ูุงูุฏู ุฌุฏุฏ (ุนุฏุฏ ูุงุฑุฏ ฺฉูุฏ):", balance);
        if (newBalance === null) return;

        const formData = new FormData();
        formData.append('old_name', name);
        formData.append('code', newCode);
        formData.append('name', newName);
        formData.append('balance', newBalance);
        fetch('/edit-balance', { method: 'POST', body: formData }).then(() => location.reload());
    }

    function addNewRow() {
        const code = prompt("ฺฉุฏ ูุดุชุฑ ุฌุฏุฏ:");
        if (!code) return;
        const name = prompt("ูุงู ูุดุชุฑ ุฌุฏุฏ:");
        if (!name) return;
        const balance = prompt("ูุงูุฏู ุญุณุงุจ:");
        if (balance === null || balance === "") return;

        const formData = new FormData();
        formData.append('code', code);
        formData.append('name', name);
        formData.append('balance', balance);
        fetch('/add-balance', { method: 'POST', body: formData }).then(() => location.reload());
    }

    function clearAllBalances() {
        if (confirm("ูุดุฏุงุฑ: ุขุง ุงุฒ ุญุฐู ุชูุงู ูุงูุฏูโูุง ุฐุฎุฑู ุดุฏู ุงุทููุงู ุฏุงุฑุฏุ")) {
            fetch('/clear-balances', { method: 'POST' }).then(() => location.reload());
        }
    }
</script>
{% endblock %}