<!-- templates/customer_balances.html -->
{% extends "base.html" %}

{% block content %}
<div class="summary-card">
    <div class="summary-card-header">
        <h2 style="margin:0;">ูุฏุฑุช ูุงูุฏู ุญุณุงุจ ูุดุชุฑุงู</h2>
    </div>
    <div class="summary-card-body">

        <!-- ฺฉุงุฑุช ุขูพููุฏ ูุงู -->
        <div class="upload-card"
            style="margin-bottom: 24px; padding: 15px; border: 1px solid #eee; border-radius: 8px;">
            <div class="upload-card-title" style="font-weight: bold; margin-bottom: 10px;">ุจุงุฑฺฏุฐุงุฑ ูุงู ุงฺฉุณู ูุงูุฏูโูุง
            </div>
            <form action="/upload-balances" method="post" enctype="multipart/form-data" class="form-inline">
                <div class="form-row" style="margin-left: 10px;">
                    <label style="display:block; margin-bottom:5px; font-size:0.9em;">ูุงู ุงฺฉุณู ฺฏุฒุงุฑุด ุญุณุงุจุฏุงุฑ (ุดุงูู
                        ูุฏุฑูุง ุฏู ุฑุฏู)</label>
                    <input type="file" name="balances_file" accept=".xlsx,.xls" required />
                </div>
                <button type="submit" class="pill-button">ุจุงุฑฺฏุฐุงุฑ ู ุจุฑูุฒุฑุณุงู ูุงูุฏูโูุง</button>
            </form>
        </div>

        <!-- ุฏฺฉููโูุง ุนููุงุช -->
        <div style="margin-bottom: 15px; display: flex; gap: 10px;">
            <button type="button" class="pill-button" onclick="addNewRow()">โ ุงูุฒูุฏู ุฑุฏู ุฏุณุช</button>
            <button type="button" class="pill-button" style="background-color: #fee2e2; color: #b91c1c;"
                onclick="clearAllBalances()">๐๏ธ ุญุฐู ุชูุงู ูุงูุฏูโูุง</button>
        </div>

        <!-- ุฌุฏูู ุฏุงุฏูโูุง -->
        <h3>ูุงูุฏูโูุง ูุนู ุฏุฑ ุญุงูุธู ุณุณุชู</h3>
        <div class="table-wrapper" style="overflow-x: auto;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ฺฉุฏ ูุดุชุฑ</th>
                        <th>ูุงู ูุดุชุฑ</th>
                        <th>ูุงูุฏู ุญุณุงุจ</th>
                        <th>ุนููุงุช</th>
                    </tr>
                </thead>
                <tbody>
                    {% if balances %}
                    {% for row in balances %}
                    <tr>
                        <td>{{ row.display_code }}</td>
                        <td>{{ row.name }}</td>
                        <td style="direction: ltr; text-align: right; color: {{ row.color }}; font-weight: bold;">
                            {{ row.balance_fmt }}
                        </td>
                        <td>
                            <!-- ุฏฺฉูู ูุฑุงุด -->
                            <button type="button" class="pill-button"
                                onclick="editBalance('{{ row.name }}', '{{ row.raw_code }}', {{ row.balance }})">
                                ูุฑุงุด
                            </button>
                            <!-- ุฏฺฉูู ุญุฐู -->
                            <button type="button" class="pill-button" style="color:red; background: #fff1f1;"
                                onclick="deleteBalance('{{ row.raw_code }}', '{{ row.name }}')">
                                ุญุฐู
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="4" style="text-align:center; padding: 20px;">ูููุฒ ูุงูุฏูโุง ุซุจุช ูุดุฏู ุงุณุช.</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function deleteBalance(code, name) {
        if (confirm("ุขุง ุงุฒ ุญุฐู ุงู ููุฑุฏ ุงุทููุงู ุฏุงุฑุฏุ")) {
            const formData = new FormData();
            formData.append('customer_code', code);
            formData.append('customer_name', name);

            fetch('/delete-balance', {
                method: 'POST',
                body: formData
            }).then(() => location.reload());
        }
    }

    function editBalance(name, code, balance) {
        const newCode = prompt("ฺฉุฏ ูุดุชุฑ:", code);
        if (newCode === null) return;

        const newName = prompt("ูุงู ูุดุชุฑ:", name);
        if (newName === null) return;

        const newBalance = prompt("ูุงูุฏู ุฌุฏุฏ (ุนุฏุฏ ูุงุฑุฏ ฺฉูุฏ):", balance);
        if (newBalance === null) return;

        const formData = new FormData();
        formData.append('old_name', name);
        formData.append('code', newCode);
        formData.append('name', newName);
        formData.append('balance', newBalance);

        fetch('/edit-balance', {
            method: 'POST',
            body: formData
        }).then(() => location.reload());
    }

    function addNewRow() {
        const code = prompt("ฺฉุฏ ูุดุชุฑ ุฌุฏุฏ:");
        if (!code) return;
        const name = prompt("ูุงู ูุดุชุฑ ุฌุฏุฏ:");
        if (!name) return;
        const balance = prompt("ูุงูุฏู ุญุณุงุจ:");
        if (balance === null || balance === "") return;

        const formData = new FormData();
        formData.append('code', code);
        formData.append('name', name);
        formData.append('balance', balance);

        fetch('/add-balance', {
            method: 'POST',
            body: formData
        }).then(() => location.reload());
    }

    function clearAllBalances() {
        if (confirm("ูุดุฏุงุฑ: ุขุง ุงุฒ ุญุฐู ุชูุงู ูุงูุฏูโูุง ุฐุฎุฑู ุดุฏู ุงุทููุงู ุฏุงุฑุฏุ ุงู ุนููุงุช ุบุฑูุงุจู ุจุงุฒฺฏุดุช ุงุณุช.")) {
            fetch('/clear-balances', { method: 'POST' })
                .then(() => location.reload());
        }
    }
</script>
{% endblock %}