{% extends "base.html" %}

{% block content %}
<h1>ุฑูุน ุงุดฺฉุงู ฺฉุฏูุง ูุดุชุฑ</h1>

{% if error_message %}
<div class="message message-error">
    {{ error_message | safe }}
</div>
{% else %}

<!-- ุฏุจุงฺฏ -->
<div
    style="background:#f0fdf4; color:#166534; padding:10px; border:1px solid #bbf7d0; margin-bottom:20px; border-radius:5px; font-size:12px;">
    <strong>ูุถุนุช ุณุณุชู:</strong><br>
    - ุชุนุฏุงุฏ ฺฉู ุฑุฏูโูุง: {{ total_rows }}<br>
    - ุชุนุฏุงุฏ ฺฉุฏูุง ุงูุช ูุดุฏู: {{ unresolved_count }}<br>
    - ุชุนุฏุงุฏ ฺฉุฏูุง ุงูุช ุดุฏู: {{ resolved_count }}
</div>

<div style="margin-bottom: 15px;">
    <button type="button" class="pill-button" onclick="addNewRow()">โ ุงูุฒูุฏู ุณุทุฑ ุฌุฏุฏ</button>
</div>

<h2>๐ด ูุณุช ูุดุชุฑุงู ฺฉู ฺฉุฏุดุงู ุงูุช ูุดุฏ</h2>
<p>ูุทูุงู ฺฉุฏ ูุดุชุฑ ุตุญุญ ุฑุง ุฏุฑ ฺฉุงุฏุฑ ุฑูุจุฑู ูุงู ูุงุฑุฏ ฺฉูุฏ.</p>

<form id="fix-form">
    <div class="table-wrapper">
        <table class="data-table table-unresolved">
            <thead>
                <tr>
                    <th>ูุงู ูุดุชุฑ</th>
                    <th>ฺฉุฏ ูุดุชุฑ (ุงุตูุงุญ ุดุฏู)</th>
                    <th>ุนููุงุช</th>
                </tr>
            </thead>
            <tbody>
                {% if unresolved_items %}
                {% for item in unresolved_items %}
                <tr class="unresolved-row">
                    <td>
                        <input type="text" name="fix_name" value="{{ item.name }}" readonly
                            style="border:none; background:transparent; width:100%;" />
                    </td>
                    <td>
                        <input type="text" name="fix_code" placeholder="ฺฉุฏ ูุดุชุฑ ุฑุง ูุงุฑุฏ ฺฉูุฏ" style="width: 100%;" />
                    </td>
                    <td>
                        <button type="button" class="pill-button" style="padding:5px 10px;"
                            onclick="removeAndBlacklistRow(this)">โ</button>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan='3' style='text-align:center; color:green;'>ููู ฺฉุฏูุง ุจุง ููููุช ุงูุช ุดุฏูุฏ! โ</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
    <div style="margin-top: 20px;">
        <button type="button" class="pill-button" onclick="submitFixes()"
            style="background-color: #10b981; color: white;">๐พ ุฐุฎุฑู ุชุบุฑุงุช</button>
    </div>
</form>

<hr />

<h2>๐ข ูุณุช ูุดุชุฑุงู ฺฉู ฺฉุฏุดุงู ุงูุช ุดุฏ</h2>
<div class="table-wrapper">
    <table class="data-table table-resolved">
        <thead>
            <tr>
                <th>ูุงู ูุดุชุฑ</th>
                <th>ฺฉุฏ ูุดุชุฑ</th>
                <th>ุนููุงุช</th>
            </tr>
        </thead>
        <tbody>
            {% for item in resolved_items %}
            <tr class="resolved-row">
                <td>{{ item.name }}</td>
                <td style="color: green; font-weight: bold;">{{ item.code }}</td>
                <td>
                    {% if not item.is_blacklisted %}
                    <button type="button" class="pill-button" onclick="editResolvedRow(this)">ูุฑุงุด</button>
                    <button type="button" class="pill-button" style="color:red;"
                        onclick="deleteResolvedRow(this)">ุญุฐู</button>
                    <button type="button" class="pill-button" style="background:Pink; color:Black; padding:5px 10px;"
                        onclick="addToBlacklist('{{ item.name }}')">ุงูุฒูุฏู ุจู ูุณุช ุณุงู ๐ซ</button>
                    {% else %}
                    <button type="button" class="pill-button" style="background:#f59e0b; color:white; padding:5px 10px;"
                        onclick="removeFromBlacklist('{{ item.name }}')">ุฎุฑูุฌ ุงุฒ ูุณุช ุณุงู ๐ซ</button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<a class="footer-link" href="/">ุจุงุฒฺฏุดุช ุจู ุตูุญู ุงุตู</a>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    function removeRow(btn) {
        const row = btn.closest('tr');
        row.remove();
    }

    function removeAndBlacklistRow(btn) {
        const row = btn.closest('tr');
        const nameInput = row.querySelector('input[name="fix_name"]');
        const name = nameInput ? nameInput.value : "";
        if (confirm("ุขุง ุงุฒ ุตุฑู ูุธุฑ ุงุฒ ุงู ฺฉุฏ ุงุทููุงู ุฏุงุฑุฏุ")) {
            fetch('/blacklist-item', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ "customer_name": name })
            })
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'ok') {
                        row.remove();
                        alert('ูุงู ูุดุชุฑ ุจู ูุณุช ุณุงู ุงุถุงูู ู ุงุฒ ูุณุช ุญุฐู ุดุฏ.');
                    } else {
                        alert('ุฎุทุง: ' + result.message);
                    }
                })
                .catch(error => console.error('Error:', error));
        }
    }

    function addNewRow() {
        const tbody = document.querySelector('#fix-form tbody');
        const newRow = document.createElement('tr');
        newRow.className = 'unresolved-row';
        newRow.innerHTML = `
        <td>
            <input type="text" name="fix_name" placeholder="ูุงู ูุดุชุฑ ุฌุฏุฏ" style="width:100%;" />
        </td>
        <td>
            <input type="text" name="fix_code" placeholder="ฺฉุฏ ูุดุชุฑ" style="width: 100%;" />
        </td>
        <td>
            <button type="button" class="pill-button" style="background:#ef4444; color:white; padding:5px 10px;" onclick="removeRow(this)">โ</button>
        </td>
    `;
        tbody.appendChild(newRow);
    }

    function editResolvedRow(btn) {
        const row = btn.closest('tr');
        const nameCell = row.cells[0];
        const codeCell = row.cells[1];
        const currentName = nameCell.innerText;
        const currentCode = codeCell.innerText;
        const newName = prompt("ูุฑุงุด ูุงู ูุดุชุฑ:", currentName);
        if (newName === null) return;
        const newCode = prompt("ูุฑุงุด ฺฉุฏ ูุดุชุฑ:", currentCode);
        if (newCode === null) return;
        nameCell.innerText = newName;
        codeCell.innerText = newCode;
        saveResolvedEdit(currentName, newName, newCode);
    }

    function deleteResolvedRow(btn) {
        const row = btn.closest('tr');
        const nameCell = row.cells[0];
        const nameToDelete = nameCell.innerText;
        if (confirm("ุขุง ุงุฒ ุญุฐู ุงู ููุฑุฏ ุงุทููุงู ุฏุงุฑุฏุ")) {
            fetch('/delete-resolved-item', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ "customer_name": nameToDelete })
            })
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'ok') {
                        row.remove();
                        alert('ููุฑุฏ ุจุง ููููุช ุญุฐู ุดุฏ.');
                    } else {
                        alert('ุฎุทุง ุฏุฑ ุญุฐู: ' + result.message);
                    }
                })
                .catch(error => console.error('Error:', error));
        }
    }

    function saveResolvedEdit(oldName, newName, newCode) {
        fetch('/edit-resolved-item', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                "old_name": oldName,
                "new_name": newName,
                "new_code": newCode
            })
        })
            .then(response => response.json())
            .then(result => {
                if (result.status !== 'ok') {
                    alert('ุฎุทุง ุฏุฑ ุฐุฎุฑู ูุฑุงุด: ' + result.message);
                    location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ุฎุทุง ุฏุฑ ุงุฑุชุจุงุท ุจุง ุณุฑูุฑ');
                location.reload();
            });
    }

    function addToBlacklist(name) {
        if (confirm(`ุขุง ูโุฎูุงูุฏ ยซ${name}ยป ุฑุง ุจู ูุณุช ุณุงู ุงุถุงูู ฺฉูุฏุ`)) {
            fetch('/blacklist-item', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ "customer_name": name })
            })
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'ok') {
                        alert('ูุงู ูุดุชุฑ ุจู ูุณุช ุณุงู ุงุถุงูู ุดุฏ.');
                        location.reload();
                    } else {
                        alert('ุฎุทุง: ' + result.message);
                    }
                })
                .catch(error => console.error('Error:', error));
        }
    }

    function removeFromBlacklist(name) {
        if (confirm(`ุขุง ูโุฎูุงูุฏ ยซ${name}ยป ุฑุง ุงุฒ ูุณุช ุณุงู ุฎุงุฑุฌ ฺฉูุฏุ`)) {
            fetch('/unblacklist-item', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ "customer_name": name })
            })
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'ok') {
                        alert('ูุงู ูุดุชุฑ ุงุฒ ูุณุช ุณุงู ุญุฐู ุดุฏ.');
                        location.reload();
                    } else {
                        alert('ุฎุทุง: ' + result.message);
                    }
                })
                .catch(error => console.error('Error:', error));
        }
    }

    function submitFixes() {
        const form = document.getElementById('fix-form');
        const formData = new FormData(form);
        const data = [];
        const names = formData.getAll('fix_name');
        const codes = formData.getAll('fix_code');
        for (let i = 0; i < names.length; i++) {
            const name = names[i].trim();
            const code = codes[i].trim();
            if (name && code) {
                data.push({
                    "CustomerName": name,
                    "CustomerCode": code
                });
            }
        }
        if (data.length === 0) {
            alert("ูฺ ฺฉุฏ ุจุฑุง ุฐุฎุฑู ูุงุฑุฏ ูุดุฏู ุงุณุช.");
            return;
        }
        fetch('/manual-map-save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(result => {
                if (result.status === 'ok') {
                    alert('ฺฉุฏูุง ุจุง ููููุช ุฐุฎุฑู ุดุฏูุฏ ู ูุงู ุงฺฉุณู ุจุฑูุฒุฑุณุงู ุดุฏ.');
                    location.reload();
                } else {
                    alert('ุฎุทุง ุฏุฑ ุฐุฎุฑู: ' + result.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ุฎุทุง ุฏุฑ ุงุฑุชุจุงุท ุจุง ุณุฑูุฑ');
            });
    }
</script>
{% endblock %}